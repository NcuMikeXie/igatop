%% A 257 LINE 3D ISOGEOMETRIC TOPOLOGY OPTIMIZATION CODE BASED ON BEZIER EXTRACTION %%
function iga_top3D257(nelx,nely,nelz,volfrac,penal,rmin)
%% MATERIAL PROPERTIES
E0 = 1;
Emin = 1e-3;
nu = 0.3;
%% PREPARE IGA
noPtsX = nelx + 2;
noPtsY = nely + 2;
noPtsZ = nelz + 2;
noCtrPts   = noPtsX * noPtsY *noPtsZ;
noElems = nelx * nely *nelz;
noDofs = 3*noCtrPts;
noPtsX_B = 2*nelx + 1;
noPtsY_B = 2*nely + 1;
noPtsZ_B = 2*nelz + 1;
noCtrPts_B   = noPtsX_B * noPtsY_B *noPtsZ_B;
A11 = [864,144,-48,144,-72,-72,-48,-72,-40,144,-72,-72,-72,-108,-60,-72,-60,-28,-48,-72,-40,-72,-60,-28,-40,-28,-12;
    144,672,144,-72,144,-72,-72,-16,-72,-72,144,-72,-108,-24,-108,-60,-40,-60,-72,-16,-72,-60,-40,-60,-28,-24,-28;
    -48,144,864,-72,-72,144,-40,-72,-48,-72,-72,144,-60,-108,-72,-28,-60,-72,-40,-72,-48,-28,-60,-72,-12,-28,-40;
    144,-72,-72,672,144,-16,144,-72,-72,-72,-108,-60,144,-24,-40,-72,-108,-60,-72,-60,-28,-16,-40,-24,-72,-60,-28;
    -72,144,-72,144,512,144,-72,144,-72,-108,-24,-108,-24,128,-24,-108,-24,-108,-60,-40,-60,-40,0,-40,-60,-40,-60;
    -72,-72,144,-16,144,672,-72,-72,144,-60,-108,-72,-40,-24,144,-60,-108,-72,-28,-60,-72,-24,-40,-16,-28,-60,-72;
    -48,-72,-40,144,-72,-72,864,144,-48,-72,-60,-28,-72,-108,-60,144,-72,-72,-40,-28,-12,-72,-60,-28,-48,-72,-40;
    -72,-16,-72,-72,144,-72,144,672,144,-60,-40,-60,-108,-24,-108,-72,144,-72,-28,-24,-28,-60,-40,-60,-72,-16,-72;
    -40,-72,-48,-72,-72,144,-48,144,864,-28,-60,-72,-60,-108,-72,-72,-72,144,-12,-28,-40,-28,-60,-72,-40,-72,-48;
    144,-72,-72,-72,-108,-60,-72,-60,-28,672,144,-16,144,-24,-40,-16,-40,-24,144,-72,-72,-72,-108,-60,-72,-60,-28;
    -72,144,-72,-108,-24,-108,-60,-40,-60,144,512,144,-24,128,-24,-40,0,-40,-72,144,-72,-108,-24,-108,-60,-40,-60;
    -72,-72,144,-60,-108,-72,-28,-60,-72,-16,144,672,-40,-24,144,-24,-40,-16,-72,-72,144,-60,-108,-72,-28,-60,-72;
    -72,-108,-60,144,-24,-40,-72,-108,-60,144,-24,-40,512,128,0,144,-24,-40,-72,-108,-60,144,-24,-40,-72,-108,-60;
    -108,-24,-108,-24,128,-24,-108,-24,-108,-24,128,-24,128,384,128,-24,128,-24,-108,-24,-108,-24,128,-24,-108,-24,-108;
    -60,-108,-72,-40,-24,144,-60,-108,-72,-40,-24,144,0,128,512,-40,-24,144,-60,-108,-72,-40,-24,144,-60,-108,-72;
    -72,-60,-28,-72,-108,-60,144,-72,-72,-16,-40,-24,144,-24,-40,672,144,-16,-72,-60,-28,-72,-108,-60,144,-72,-72;
    -60,-40,-60,-108,-24,-108,-72,144,-72,-40,0,-40,-24,128,-24,144,512,144,-60,-40,-60,-108,-24,-108,-72,144,-72;
    -28,-60,-72,-60,-108,-72,-72,-72,144,-24,-40,-16,-40,-24,144,-16,144,672,-28,-60,-72,-60,-108,-72,-72,-72,144;
    -48,-72,-40,-72,-60,-28,-40,-28,-12,144,-72,-72,-72,-108,-60,-72,-60,-28,864,144,-48,144,-72,-72,-48,-72,-40;
    -72,-16,-72,-60,-40,-60,-28,-24,-28,-72,144,-72,-108,-24,-108,-60,-40,-60,144,672,144,-72,144,-72,-72,-16,-72;
    -40,-72,-48,-28,-60,-72,-12,-28,-40,-72,-72,144,-60,-108,-72,-28,-60,-72,-48,144,864,-72,-72,144,-40,-72,-48;
    -72,-60,-28,-16,-40,-24,-72,-60,-28,-72,-108,-60,144,-24,-40,-72,-108,-60,144,-72,-72,672,144,-16,144,-72,-72;
    -60,-40,-60,-40,0,-40,-60,-40,-60,-108,-24,-108,-24,128,-24,-108,-24,-108,-72,144,-72,144,512,144,-72,144,-72;
    -28,-60,-72,-24,-40,-16,-28,-60,-72,-60,-108,-72,-40,-24,144,-60,-108,-72,-72,-72,144,-16,144,672,-72,-72,144;
    -40,-28,-12,-72,-60,-28,-48,-72,-40,-72,-60,-28,-72,-108,-60,144,-72,-72,-48,-72,-40,144,-72,-72,864,144,-48;
    -28,-24,-28,-60,-40,-60,-72,-16,-72,-60,-40,-60,-108,-24,-108,-72,144,-72,-72,-16,-72,-72,144,-72,144,672,144;
    -12,-28,-40,-28,-60,-72,-40,-72,-48,-28,-60,-72,-60,-108,-72,-72,-72,144,-40,-72,-48,-72,-72,144,-48,144,864];
A12 = [270,-180,-90,180,-120,-60,90,-60,-30,135,-90,-45,90,-60,-30,45,-30,-15,45,-30,-15,30,-20,-10,15,-10,-5;
      180,0,-180,120,0,-120,60,0,-60,90,0,-90,60,0,-60,30,0,-30,30,0,-30,20,0,-20,10,0,-10;
      90,180,-270,60,120,-180,30,60,-90,45,90,-135,30,60,-90,15,30,-45,15,30,-45,10,20,-30,5,10,-15;
      -180,120,60,0,0,0,180,-120,-60,-90,60,30,0,0,0,90,-60,-30,-30,20,10,0,0,0,30,-20,-10;
      -120,0,120,0,0,0,120,0,-120,-60,0,60,0,0,0,60,0,-60,-20,0,20,0,0,0,20,0,-20;
      -60,-120,180,0,0,0,60,120,-180,-30,-60,90,0,0,0,30,60,-90,-10,-20,30,0,0,0,10,20,-30;
      -90,60,30,-180,120,60,-270,180,90,-45,30,15,-90,60,30,-135,90,45,-15,10,5,-30,20,10,-45,30,15;
      -60,0,60,-120,0,120,-180,0,180,-30,0,30,-60,0,60,-90,0,90,-10,0,10,-20,0,20,-30,0,30;
      -30,-60,90,-60,-120,180,-90,-180,270,-15,-30,45,-30,-60,90,-45,-90,135,-5,-10,15,-10,-20,30,-15,-30,45;
      135,-90,-45,90,-60,-30,45,-30,-15,180,-120,-60,120,-80,-40,60,-40,-20,135,-90,-45,90,-60,-30,45,-30,-15;
      90,0,-90,60,0,-60,30,0,-30,120,0,-120,80,0,-80,40,0,-40,90,0,-90,60,0,-60,30,0,-30;
      45,90,-135,30,60,-90,15,30,-45,60,120,-180,40,80,-120,20,40,-60,45,90,-135,30,60,-90,15,30,-45;
      -90,60,30,0,0,0,90,-60,-30,-120,80,40,0,0,0,120,-80,-40,-90,60,30,0,0,0,90,-60,-30;
      -60,0,60,0,0,0,60,0,-60,-80,0,80,0,0,0,80,0,-80,-60,0,60,0,0,0,60,0,-60;
      -30,-60,90,0,0,0,30,60,-90,-40,-80,120,0,0,0,40,80,-120,-30,-60,90,0,0,0,30,60,-90;
      -45,30,15,-90,60,30,-135,90,45,-60,40,20,-120,80,40,-180,120,60,-45,30,15,-90,60,30,-135,90,45;
      -30,0,30,-60,0,60,-90,0,90,-40,0,40,-80,0,80,-120,0,120,-30,0,30,-60,0,60,-90,0,90;
      -15,-30,45,-30,-60,90,-45,-90,135,-20,-40,60,-40,-80,120,-60,-120,180,-15,-30,45,-30,-60,90,-45,-90,135;
      45,-30,-15,30,-20,-10,15,-10,-5,135,-90,-45,90,-60,-30,45,-30,-15,270,-180,-90,180,-120,-60,90,-60,-30;
      30,0,-30,20,0,-20,10,0,-10,90,0,-90,60,0,-60,30,0,-30,180,0,-180,120,0,-120,60,0,-60;
      15,30,-45,10,20,-30,5,10,-15,45,90,-135,30,60,-90,15,30,-45,90,180,-270,60,120,-180,30,60,-90;
      -30,20,10,0,0,0,30,-20,-10,-90,60,30,0,0,0,90,-60,-30,-180,120,60,0,0,0,180,-120,-60;
      -20,0,20,0,0,0,20,0,-20,-60,0,60,0,0,0,60,0,-60,-120,0,120,0,0,0,120,0,-120;
      -10,-20,30,0,0,0,10,20,-30,-30,-60,90,0,0,0,30,60,-90,-60,-120,180,0,0,0,60,120,-180;
      -15,10,5,-30,20,10,-45,30,15,-45,30,15,-90,60,30,-135,90,45,-90,60,30,-180,120,60,-270,180,90;
      -10,0,10,-20,0,20,-30,0,30,-30,0,30,-60,0,60,-90,0,90,-60,0,60,-120,0,120,-180,0,180;
      -5,-10,15,-10,-20,30,-15,-30,45,-15,-30,45,-30,-60,90,-45,-90,135,-30,-60,90,-60,-120,180,-90,-180,270];
B11 = [-1440,-432,-48,-144,72,72,144,120,56,-144,72,72,216,180,84,168,108,44,144,120,56,168,108,44,88,52,20;
    -432,-1056,-432,72,-144,72,120,80,120,72,-144,72,180,120,180,108,104,108,120,80,120,108,104,108,52,56,52;
    -48,-432,-1440,72,72,-144,56,120,144,72,72,-144,84,180,216,44,108,168,56,120,144,44,108,168,20,52,88;
    -144,72,72,-1152,-384,-64,-144,72,72,216,180,84,-192,0,32,216,180,84,168,108,44,64,64,32,168,108,44;
    72,-144,72,-384,-832,-384,72,-144,72,180,120,180,0,-160,0,180,120,180,108,104,108,64,32,64,108,104,108;
    72,72,-144,-64,-384,-1152,72,72,-144,84,180,216,32,0,-192,84,180,216,44,108,168,32,64,64,44,108,168;
    144,120,56,-144,72,72,-1440,-432,-48,168,108,44,216,180,84,-144,72,72,88,52,20,168,108,44,144,120,56;
    120,80,120,72,-144,72,-432,-1056,-432,108,104,108,180,120,180,72,-144,72,52,56,52,108,104,108,120,80,120;
    56,120,144,72,72,-144,-48,-432,-1440,44,108,168,84,180,216,72,72,-144,20,52,88,44,108,168,56,120,144;
    -144,72,72,216,180,84,168,108,44,-1152,-384,-64,-192,0,32,64,64,32,-144,72,72,216,180,84,168,108,44;
    72,-144,72,180,120,180,108,104,108,-384,-832,-384,0,-160,0,64,32,64,72,-144,72,180,120,180,108,104,108;
    72,72,-144,84,180,216,44,108,168,-64,-384,-1152,32,0,-192,32,64,64,72,72,-144,84,180,216,44,108,168;
    216,180,84,-192,0,32,216,180,84,-192,0,32,-896,-320,-64,-192,0,32,216,180,84,-192,0,32,216,180,84;
    180,120,180,0,-160,0,180,120,180,0,-160,0,-320,-640,-320,0,-160,0,180,120,180,0,-160,0,180,120,180;
    84,180,216,32,0,-192,84,180,216,32,0,-192,-64,-320,-896,32,0,-192,84,180,216,32,0,-192,84,180,216;
    168,108,44,216,180,84,-144,72,72,64,64,32,-192,0,32,-1152,-384,-64,168,108,44,216,180,84,-144,72,72;
    108,104,108,180,120,180,72,-144,72,64,32,64,0,-160,0,-384,-832,-384,108,104,108,180,120,180,72,-144,72;
    44,108,168,84,180,216,72,72,-144,32,64,64,32,0,-192,-64,-384,-1152,44,108,168,84,180,216,72,72,-144;
    144,120,56,168,108,44,88,52,20,-144,72,72,216,180,84,168,108,44,-1440,-432,-48,-144,72,72,144,120,56;
    120,80,120,108,104,108,52,56,52,72,-144,72,180,120,180,108,104,108,-432,-1056,-432,72,-144,72,120,80,120;
    56,120,144,44,108,168,20,52,88,72,72,-144,84,180,216,44,108,168,-48,-432,-1440,72,72,-144,56,120,144;
    168,108,44,64,64,32,168,108,44,216,180,84,-192,0,32,216,180,84,-144,72,72,-1152,-384,-64,-144,72,72;
    108,104,108,64,32,64,108,104,108,180,120,180,0,-160,0,180,120,180,72,-144,72,-384,-832,-384,72,-144,72;
    44,108,168,32,64,64,44,108,168,84,180,216,32,0,-192,84,180,216,72,72,-144,-64,-384,-1152,72,72,-144;
    88,52,20,168,108,44,144,120,56,168,108,44,216,180,84,-144,72,72,144,120,56,-144,72,72,-1440,-432,-48;
    52,56,52,108,104,108,120,80,120,108,104,108,180,120,180,72,-144,72,120,80,120,72,-144,72,-432,-1056,-432;
    20,52,88,44,108,168,56,120,144,44,108,168,84,180,216,72,72,-144,56,120,144,72,72,-144,-48,-432,-1440];
B12 = [-270,540,270,-540,120,60,-270,60,30,-135,270,135,-270,60,30,-135,30,15,-45,90,45,-90,20,10,-45,10,5;
    -540,0,540,-120,0,120,-60,0,60,-270,0,270,-60,0,60,-30,0,30,-90,0,90,-20,0,20,-10,0,10;
    -270,-540,270,-60,-120,540,-30,-60,270,-135,-270,135,-30,-60,270,-15,-30,135,-45,-90,45,-10,-20,90,-5,-10,45;
    540,-120,-60,0,0,0,-540,120,60,270,-60,-30,0,0,0,-270,60,30,90,-20,-10,0,0,0,-90,20,10;
    120,0,-120,0,0,0,-120,0,120,60,0,-60,0,0,0,-60,0,60,20,0,-20,0,0,0,-20,0,20;
    60,120,-540,0,0,0,-60,-120,540,30,60,-270,0,0,0,-30,-60,270,10,20,-90,0,0,0,-10,-20,90;
    270,-60,-30,540,-120,-60,270,-540,-270,135,-30,-15,270,-60,-30,135,-270,-135,45,-10,-5,90,-20,-10,45,-90,-45;
    60,0,-60,120,0,-120,540,0,-540,30,0,-30,60,0,-60,270,0,-270,10,0,-10,20,0,-20,90,0,-90;
    30,60,-270,60,120,-540,270,540,-270,15,30,-135,30,60,-270,135,270,-135,5,10,-45,10,20,-90,45,90,-45;
    -135,270,135,-270,60,30,-135,30,15,-180,360,180,-360,80,40,-180,40,20,-135,270,135,-270,60,30,-135,30,15;
    -270,0,270,-60,0,60,-30,0,30,-360,0,360,-80,0,80,-40,0,40,-270,0,270,-60,0,60,-30,0,30;
    -135,-270,135,-30,-60,270,-15,-30,135,-180,-360,180,-40,-80,360,-20,-40,180,-135,-270,135,-30,-60,270,-15,-30,135;
    270,-60,-30,0,0,0,-270,60,30,360,-80,-40,0,0,0,-360,80,40,270,-60,-30,0,0,0,-270,60,30;
    60,0,-60,0,0,0,-60,0,60,80,0,-80,0,0,0,-80,0,80,60,0,-60,0,0,0,-60,0,60;
    30,60,-270,0,0,0,-30,-60,270,40,80,-360,0,0,0,-40,-80,360,30,60,-270,0,0,0,-30,-60,270;
    135,-30,-15,270,-60,-30,135,-270,-135,180,-40,-20,360,-80,-40,180,-360,-180,135,-30,-15,270,-60,-30,135,-270,-135;
    30,0,-30,60,0,-60,270,0,-270,40,0,-40,80,0,-80,360,0,-360,30,0,-30,60,0,-60,270,0,-270;
    15,30,-135,30,60,-270,135,270,-135,20,40,-180,40,80,-360,180,360,-180,15,30,-135,30,60,-270,135,270,-135;
    -45,90,45,-90,20,10,-45,10,5,-135,270,135,-270,60,30,-135,30,15,-270,540,270,-540,120,60,-270,60,30;
    -90,0,90,-20,0,20,-10,0,10,-270,0,270,-60,0,60,-30,0,30,-540,0,540,-120,0,120,-60,0,60;
    -45,-90,45,-10,-20,90,-5,-10,45,-135,-270,135,-30,-60,270,-15,-30,135,-270,-540,270,-60,-120,540,-30,-60,270;
    90,-20,-10,0,0,0,-90,20,10,270,-60,-30,0,0,0,-270,60,30,540,-120,-60,0,0,0,-540,120,60;
    20,0,-20,0,0,0,-20,0,20,60,0,-60,0,0,0,-60,0,60,120,0,-120,0,0,0,-120,0,120;
    10,20,-90,0,0,0,-10,-20,90,30,60,-270,0,0,0,-30,-60,270,60,120,-540,0,0,0,-60,-120,540;
    45,-10,-5,90,-20,-10,45,-90,-45,135,-30,-15,270,-60,-30,135,-270,-135,270,-60,-30,540,-120,-60,270,-540,-270;
    10,0,-10,20,0,-20,90,0,-90,30,0,-30,60,0,-60,270,0,-270,60,0,-60,120,0,-120,540,0,-540;
    5,10,-45,10,20,-90,45,90,-45,15,30,-135,30,60,-270,135,270,-135,30,60,-270,60,120,-540,270,540,-270];
C1 = full(sparse(1:27,[1,2,3,10,11,12,19,20,21,4,5,6,13,14,15,22,23,24,7,8,9,16,17,18,25,26,27],ones(1,27)));
C2 = full(sparse(1:27,[1,4,7,10,13,16,19,22,25,2,5,8,11,14,17,20,23,26,3,6,9,12,15,18,21,24,27],ones(1,27)));
C3 = full(sparse(1:27,[1,10,19,4,13,22,7,16,25,2,11,20,5,14,23,8,17,26,3,12,21,6,15,24,9,18,27],ones(1,27)));
KE = E0/(1+nu)/(1-2*nu)/5400*([A11,A12,C1'*A12*C1;A12',A11,C2'*A12*C2;C1'*A12'*C1,C2'*A12'*C2,A11]+...
      nu*[B11,B12,C1'*B12*C1;B12',C2'*B11*C2,C2'*B12*C2;C1'*B12'*C1,C2'*B12'*C2,C3'*B11*C3]);
Cxi = repmat([0.5,0,0;0.5,1,0.5;0,0,0.5],1,1,nelx);
Cxi(:,1,1) = [1;0;0];
Cxi(:,3,nelx) = [0;0;1];
Cet = repmat([0.5,0,0;0.5,1,0.5;0,0,0.5],1,1,nely);
Cet(:,1,1) = [1;0;0];
Cet(:,3,nely) = [0;0;1];
Cze = repmat([0.5,0,0;0.5,1,0.5;0,0,0.5],1,1,nelz);
Cze(:,1,1) = [1;0;0];
Cze(:,3,nelz) = [0;0;1];
CxiG = sparse(noPtsX,noPtsX_B);
CxiG(noPtsX*([1 2:2:noPtsX_B-1 noPtsX_B]-1)+(1:noPtsX))=1;
CxiG(noPtsX*([3:2:noPtsX_B-2 3:2:noPtsX_B-2]-1)+[2:noPtsX-2,3:noPtsX-1])=0.5;
CetG = sparse(noPtsY,noPtsY_B);
CetG(noPtsY*([1 2:2:noPtsY_B-1 noPtsY_B]-1)+(1:noPtsY))=1;
CetG(noPtsY*([3:2:noPtsY_B-2 3:2:noPtsY_B-2]-1)+[2:noPtsY-2,3:noPtsY-1])=0.5;
CzeG = sparse(noPtsZ,noPtsZ_B);
CzeG(noPtsZ*([1 2:2:noPtsZ_B-1 noPtsZ_B]-1)+(1:noPtsZ))=1;
CzeG(noPtsZ*([3:2:noPtsZ_B-2 3:2:noPtsZ_B-2]-1)+[2:noPtsZ-2,3:noPtsZ-1])=0.5;
elConnU_B = bsxfun(@plus,(1:2:nelx*2-1)',0:2);
elConnV_B = bsxfun(@plus,(1:2:nely*2-1)',0:2);
elConnW_B = bsxfun(@plus,(1:2:nelz*2-1)',0:2);
element_B = (reshape(permute(repmat(elConnW_B,1,1,nelx,nely,3,3),[3 4 1 5 6 2]),noElems,27)-1)*noPtsY_B*noPtsX_B+...
    (reshape(permute(repmat(elConnV_B,1,1,nelx,nelz,3,3),[3 1 4 5 2 6]),noElems,27)-1)*noPtsX_B+...
    reshape(permute(repmat(elConnU_B,1,1,nely,nelz,3,3),[1 3 4 2 5 6]),noElems,27);
edofMat_B = [element_B noCtrPts_B+element_B 2*noCtrPts_B+element_B];
elConnU = bsxfun(@plus,(1:nelx)',0:2);
elConnV = bsxfun(@plus,(1:nely)',0:2);
elConnW = bsxfun(@plus,(1:nelz)',0:2);
element = (reshape(permute(repmat(elConnW,1,1,nelx,nely,3,3),[3 4 1 5 6 2]),noElems,27)-1)*noPtsY*noPtsX+...
    (reshape(permute(repmat(elConnV,1,1,nelx,nelz,3,3),[3 1 4 5 2 6]),noElems,27)-1)*noPtsX+...
    reshape(permute(repmat(elConnU,1,1,nely,nelz,3,3),[1 3 4 2 5 6]),noElems,27);
edofMat = [element noCtrPts+element 2*noCtrPts+element];
iK = reshape(kron(edofMat,ones(81,1))',6561*noElems,1);
jK = reshape(kron(edofMat,ones(1,81))',6561*noElems,1);
clear elConnU_B elConnV_B elConnW_B element_B elConnU elConnV elConnW element edofMat
%% BOUNDARY OF CANTILEVER BEAM
ind = [noPtsX*floor(noPtsY/2)+noPtsX*noPtsY*floor(noPtsZ/2) noPtsX*floor(noPtsY/2)+noPtsX*noPtsY*(floor(noPtsZ/2)+1)...
       noPtsX*(floor(noPtsY/2)+1)+noPtsX*noPtsY*floor(noPtsZ/2)  noPtsX*(floor(noPtsY/2)+1)+noPtsX*noPtsY*(floor(noPtsZ/2)+1)];
F = sparse(ind+2*noCtrPts,1,-1/numel(ind),noDofs,1);
U = zeros(noDofs,1);
fixeddofs = 1:noPtsX:noDofs;
alldofs = 1:noDofs;
freedofs = setdiff(alldofs,fixeddofs);
%% PREPARE FILTER
iH = ones(noElems*(2*(ceil(rmin)-1)+1)^3,1);
jH = ones(size(iH));
sH = zeros(size(iH));
k = 0;
for i1 = 1:nelz
    for j1 = 1:nely
        for k1 = 1:nelx
            e1 = (i1-1)*nely*nelx+(j1-1)*nelx+k1;
            for i2 = max(i1-(ceil(rmin)-1),1):min(i1+(ceil(rmin)-1),nelz)
                for j2 = max(j1-(ceil(rmin)-1),1):min(j1+(ceil(rmin)-1),nely)
                    for k2 = max(k1-(ceil(rmin)-1),1):min(k1+(ceil(rmin)-1),nelx)
                        e2 = (i2-1)*nely*nelx+(j2-1)*nelx+k2;
                        k = k+1;
                        iH(k) = e1;
                        jH(k) = e2;
                        sH(k) = max(0,rmin-sqrt((i1-i2)^2+(j1-j2)^2+(k1-k2)^2));
                    end
                end
            end
        end
    end
end
H = sparse(iH,jH,sH);
Hs = sum(H,2);
%% INITIALIZE ITERATION
x = repmat(volfrac,nelx,nely,nelz);
loop = 0;
change = 1;
while change > 0.01
  loop = loop + 1;
  %% IGA
  sK = zeros(6561*noElems,1,1);
  m = 0;
  for k = 1:nelz
      for j = 1:nely
          for i = 1:nelx
              m = m+1;
              CK = [kron(Cze(:,:,k),kron(Cet(:,:,j),Cxi(:,:,i))),zeros(27,2*27);...
                  zeros(27,27),kron(Cze(:,:,k),kron(Cet(:,:,j),Cxi(:,:,i))),zeros(27,27);...
                  zeros(27,2*27),kron(Cze(:,:,k),kron(Cet(:,:,j),Cxi(:,:,i)))];
              sK((m-1)*6561+1:m*6561) = reshape(CK*KE*CK',6561,1)*(Emin+x(i,j,k).^penal*(E0-Emin));
          end
      end
  end
  K = sparse(iK,jK,sK);
  K = (K+K')/2;
  U(freedofs) = K(freedofs,freedofs)\F(freedofs);
  U_B = full([kron(CzeG,kron(CetG,CxiG))'*U(1:noCtrPts);kron(CzeG,kron(CetG,CxiG))'*U(noCtrPts+(1:noCtrPts));...
      kron(CzeG,kron(CetG,CxiG))'*U(2*noCtrPts+(1:noCtrPts))]);
  %% OBJECTIVE FUNCTION AND SENSITIVITY ANALYSIS
  ce = reshape(sum((U_B(edofMat_B)*KE).*U_B(edofMat_B),2),nelx,nely,nelz);
  c = sum(sum(sum((Emin+x.^penal*(E0-Emin)).*ce)));
  dc = -penal*(E0-Emin)*x.^(penal-1).*ce;
  dv = ones(nelx,nely,nelz);
  %% FILTERING/MODIFICATION OF SENSITIVITIES
  dc(:) = H*(x(:).*dc(:))./Hs./max(1e-3,x(:));
  %% OPTIMALITY CRITERIA UPDATE OF DESIGN VARIABLES AND PHYSICAL DENSITIES
  l1 = 0; l2 = 1e9; move = 0.2;
  while (l2-l1)/(l1+l2) > 1e-3
    lmid = 0.5*(l2+l1);
    xnew = max(0,max(x-move,min(1,min(x+move,x.*sqrt(-dc./dv/lmid)))));
    if sum(xnew(:)) > volfrac*noElems, l1 = lmid; else l2 = lmid; end
  end
  change = max(abs(xnew(:)-x(:)));
  x = xnew;
  %% PRINT RESULTS
  fprintf(' It.:%5i Obj.:%11.4f Vol.:%7.3f ch.:%7.3f\n',loop,c,mean(x(:)),change);
end
%% PLOT RESULT
face = [1 2 3 4; 2 6 7 3; 4 3 7 8; 1 5 8 4; 1 2 6 5; 5 6 7 8];
set(gcf,'Name','ISO display','NumberTitle','off');
for k = 1:nelz
    for j = 1:nely
        for i = 1:nelx
            if (x(i,j,k) > 0.5)  % User-defined display density threshold
                vert = [i-1 j-1 k-1; i-1 j k-1; i j k-1; i j-1 k-1; i-1 j-1 k;i-1 j k; i j k;i j-1 k];
                patch('Faces',face,'Vertices',vert,'FaceColor',[0.2+0.8*(1-x(i,j,k)),0.2+0.8*(1-x(i,j,k)),0.2+0.8*(1-x(i,j,k))]);
                hold on;
            end
        end
    end
end
axis equal; axis tight; axis off; box on; view([30,30]); pause(1e-6);
% =========================================================================
% === This code was written by X XIE and A Yang, School of Advanced     ===
% === Manufacturing, Nanchang University, Nanchang, CHINA               ===
% === ----------------------------------------------------------------- ===
% === Please send your suggestions and comments to: xiexd020@ncu.edu.cn ===
% === ----------------------------------------------------------------- ===